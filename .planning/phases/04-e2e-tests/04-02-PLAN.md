---
phase: 04-e2e-tests
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - tests/e2e/helpers.ts
  - tests/e2e/upload.spec.ts
autonomous: true
requirements:
  - E2E-01
  - E2E-02
  - E2E-03
  - E2E-04

must_haves:
  truths:
    - "Uploading a single .xlsx file causes its filename to appear in the sidebar"
    - "Uploaded file's sheets are visible in the sidebar immediately after upload (auto-expand)"
    - "At least one sheet-node element appears in the graph canvas after upload"
    - "Uploading two files simultaneously shows both filenames in the sidebar"
  artifacts:
    - path: "tests/e2e/helpers.ts"
      provides: "uploadFile(), uploadFiles(), waitForNodes(), waitForDetailPanel() helper functions"
      exports: ["uploadFile", "uploadFiles", "waitForNodes", "waitForDetailPanel", "fixturePath"]
    - path: "tests/e2e/upload.spec.ts"
      provides: "E2E-01 through E2E-04 upload flow tests"
      contains: "E2E-01"
  key_links:
    - from: "tests/e2e/upload.spec.ts"
      to: "tests/e2e/helpers.ts"
      via: "import { uploadFile, uploadFiles, waitForNodes } from './helpers'"
      pattern: "from './helpers'"
    - from: "helpers.ts uploadFile()"
      to: "input[type=\"file\"]"
      via: "page.locator('input[type=\"file\"]').setInputFiles()"
      pattern: "setInputFiles"
    - from: "upload.spec.ts E2E-01"
      to: "data-testid=\"file-list-item\""
      via: "page.getByTestId('file-list-item').filter({ hasText: 'cross-sheet.xlsx' })"
      pattern: "getByTestId"
---

<objective>
Create the shared E2E helper module and the upload spec file covering the core upload-to-graph pipeline.

Purpose: The helpers module is the foundation all other spec files depend on. The upload spec validates the most critical user journey — uploading Excel files and seeing them in the sidebar and graph.
Output: tests/e2e/helpers.ts with 5 exported functions; tests/e2e/upload.spec.ts with 4 passing tests (E2E-01 through E2E-04).
</objective>

<execution_context>
@C:/Users/chase/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/chase/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-e2e-tests/04-01-SUMMARY.md
@playwright.config.ts
@tests/e2e/smoke.spec.ts

<interfaces>
<!-- Confirmed from Phase 1 infrastructure (source verified in research) -->

From playwright.config.ts:
- webServer.url: 'http://localhost:5173' (not port — url verifies server responds)
- testDir: './tests/e2e'
- baseURL: 'http://localhost:5173'
- use.baseURL means page.goto('/') navigates to http://localhost:5173/

From tests/e2e/smoke.spec.ts (existing — do not modify):
```typescript
import { test, expect } from '@playwright/test'
test('app loads without errors', async ({ page }) => {
  await page.goto('/')
  await expect(page.getByText('Drop')).toBeVisible()
})
```

From tests/fixtures/index.ts (confirmed existing):
- cross-sheet.xlsx exists
- external-ref.xlsx exists
- malformed.xlsx exists
- not-excel.txt (created in plan 04-01)

FilePanel behavior (confirmed from source):
- input[type="file"] is hidden in the DOM — setInputFiles() works directly
- FilePanel auto-expands the file on upload (setExpanded adds wb.id) — no expand click needed
- Error message renders: {error && <p data-testid="upload-error">...</p>} — conditional render
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests/e2e/helpers.ts</name>
  <files>tests/e2e/helpers.ts</files>
  <action>
Create the shared E2E helper module. All spec files import from this module — keep it clean and minimal.

```typescript
import type { Page } from '@playwright/test'
import { fileURLToPath } from 'node:url'
import path from 'node:path'

const __dirname = path.dirname(fileURLToPath(import.meta.url))

/** Resolve absolute path to a fixture file by filename */
export function fixturePath(filename: string): string {
  return path.resolve(__dirname, '../fixtures', filename)
}

/** Upload a single fixture file via the hidden file input */
export async function uploadFile(page: Page, filename: string): Promise<void> {
  const input = page.locator('input[type="file"]')
  await input.setInputFiles(fixturePath(filename))
}

/** Upload multiple fixture files simultaneously via the hidden file input */
export async function uploadFiles(page: Page, filenames: string[]): Promise<void> {
  const input = page.locator('input[type="file"]')
  await input.setInputFiles(filenames.map(fixturePath))
}

/** Wait for at least one sheet-node to be visible in the graph */
export async function waitForNodes(page: Page): Promise<void> {
  await page.getByTestId('sheet-node').first().waitFor({ state: 'visible' })
}

/** Wait for the detail panel to appear (it is conditionally rendered — null when nothing selected) */
export async function waitForDetailPanel(page: Page): Promise<void> {
  await page.getByTestId('detail-panel').waitFor({ state: 'visible' })
}
```

Note: Use `import.meta.url` + `fileURLToPath` for ESM-compatible `__dirname` (Playwright runs tests as ESM modules in this Vite project). Do NOT use `path.resolve(__dirname, ...)` with the CommonJS `__dirname` global — it will be undefined.
  </action>
  <verify>
    <automated>cd C:/Users/chase/projects/tangle && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>tests/e2e/helpers.ts exists, exports fixturePath, uploadFile, uploadFiles, waitForNodes, waitForDetailPanel; TypeScript compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create tests/e2e/upload.spec.ts (E2E-01 through E2E-04)</name>
  <files>tests/e2e/upload.spec.ts</files>
  <action>
Create the upload spec covering 4 tests. Each test uses `beforeEach` with `page.goto('/')` for clean state. Each test uploads independently — no shared upload state.

```typescript
import { test, expect } from '@playwright/test'
import { uploadFile, uploadFiles, waitForNodes } from './helpers'

test.beforeEach(async ({ page }) => {
  await page.goto('/')
})

// E2E-01: Filename appears in sidebar after upload
test('E2E-01: filename appears in sidebar after upload', async ({ page }) => {
  await uploadFile(page, 'cross-sheet.xlsx')
  await waitForNodes(page)
  await expect(
    page.getByTestId('file-list-item').filter({ hasText: 'cross-sheet.xlsx' })
  ).toBeVisible()
})

// E2E-02: Uploaded file's sheets are listed in sidebar (FilePanel auto-expands on upload)
test('E2E-02: sheet list appears in sidebar after upload', async ({ page }) => {
  await uploadFile(page, 'cross-sheet.xlsx')
  // FilePanel auto-expands on upload — no click needed
  await expect(page.getByTestId('sheet-list-item').first()).toBeVisible()
})

// E2E-03: Graph canvas renders at least one node after upload
test('E2E-03: graph renders at least one node after upload', async ({ page }) => {
  await uploadFile(page, 'cross-sheet.xlsx')
  await waitForNodes(page)
  await expect(page.getByTestId('sheet-node').first()).toBeVisible()
})

// E2E-04: Multiple files upload and all appear in sidebar and graph
test('E2E-04: multiple files upload and appear in sidebar and graph', async ({ page }) => {
  await uploadFiles(page, ['cross-sheet.xlsx', 'external-ref.xlsx'])
  await waitForNodes(page)
  await expect(page.getByTestId('file-list-item')).toHaveCount(2)
  await expect(page.getByTestId('sheet-node').first()).toBeVisible()
})
```

Important patterns:
- Always use `page.getByTestId()` not CSS class selectors
- Never use `page.waitForTimeout()` — use `waitForNodes()` or Playwright's built-in auto-wait
- `filter({ hasText: 'cross-sheet.xlsx' })` narrows to the specific file row by text content
- `toHaveCount(2)` on file-list-item verifies both files uploaded (Playwright retries until count matches)
  </action>
  <verify>
    <automated>cd C:/Users/chase/projects/tangle && npm run test:e2e -- --grep "E2E-0[1234]" 2>&1 | tail -20</automated>
  </verify>
  <done>All 4 upload tests pass: E2E-01 (filename in sidebar), E2E-02 (sheet list visible), E2E-03 (node in graph), E2E-04 (two files both present)</done>
</task>

</tasks>

<verification>
Run only the upload spec to confirm all 4 tests pass:
cd C:/Users/chase/projects/tangle && npm run test:e2e -- upload.spec.ts 2>&1 | tail -20
</verification>

<success_criteria>
- tests/e2e/helpers.ts exports: fixturePath, uploadFile, uploadFiles, waitForNodes, waitForDetailPanel
- tests/e2e/upload.spec.ts exists with 4 tests named E2E-01 through E2E-04
- npm run test:e2e -- upload.spec.ts exits 0 (all 4 tests pass)
- No fixed timeouts used — all waits are element-based
</success_criteria>

<output>
After completion, create `.planning/phases/04-e2e-tests/04-02-SUMMARY.md`
</output>
