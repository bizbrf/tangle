---
phase: 03-graph-unit-tests
plan: 02
type: tdd
wave: 2
depends_on:
  - 03-01
files_modified:
  - tests/unit/graph.test.ts
autonomous: true
requirements:
  - GRAPH-05
  - GRAPH-06
  - GRAPH-07

must_haves:
  truths:
    - "`npm test` passes with all GRAPH-05, GRAPH-06, GRAPH-07 describe blocks green"
    - "All three layout modes (`graph`, `grouped`, `overview`) return non-empty node arrays"
    - "Every node returned by all three layout modes has a non-zero `position.x` and `position.y`"
    - "`buildGraph()` with `layoutMode: 'overview'` returns exactly one non-external node per uploaded workbook"
    - "Named range nodes appear in output when `showNamedRanges: true`"
    - "Named range nodes are absent from output when `showNamedRanges: false`"
  artifacts:
    - tests/unit/graph.test.ts (3 additional describe blocks appended — GRAPH-05, GRAPH-06, GRAPH-07)
  key_links:
    - "GRAPH-06 assertion filters `nodes.filter(n => !n.data.isExternal)` to count only uploaded workbook nodes"
    - "GRAPH-07 asserts `nodes.some(n => n.data.isNamedRange)` and checks `namedRangeName` field"
    - "Grouped layout position test uses 2 workbooks to ensure inter-group edges drive non-trivial Dagre positioning"
---

<objective>
Append three more describe blocks to `tests/unit/graph.test.ts`: GRAPH-05 (layout modes produce non-zero positions), GRAPH-06 (overview mode one node per workbook), GRAPH-07 (named range node toggle). Completes Phase 3.

Purpose: Prove that the layout engine and the named-range feature flag work correctly. These are the last 3 GRAPH requirements.
Output: Complete `tests/unit/graph.test.ts` with all 7 GRAPH requirements covered, all passing.
</objective>

<execution_context>
@C:/Users/chase/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/chase/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-graph-unit-tests/03-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts — same as Plan 01. Repeated here for executor convenience. -->

From src/lib/graph.ts:
```typescript
export function buildGraph(
  workbooks: WorkbookFile[],
  layoutMode: LayoutMode = 'graph',       // 'graph' | 'grouped' | 'overview'
  hiddenFiles: Set<string> = new Set(),
  showNamedRanges: boolean = false,
): { nodes: Node<NodeData>[]; edges: Edge<EdgeData>[] }

// NodeData fields relevant to this plan:
export type NodeData = {
  isExternal: boolean;     // true for non-uploaded file-level nodes
  isFileNode: boolean;     // true for file-level nodes (overview + external)
  isNamedRange: boolean;   // true for intermediate NR nodes
  namedRangeName?: string; // name of the named range (when isNamedRange === true)
  workbookName: string;
}
```

Implementation notes verified from source:
- `layoutMode: 'overview'` routes through `buildOverviewGraph()` (private) which creates ONE file node per uploaded workbook plus external nodes for unrecognized targets
- `layoutMode: 'grouped'` uses `groupedLayout()` which dispatches to Dagre for inter-group positioning
- `layoutMode: 'graph'` uses `dagreLayout()` directly
- Dagre assigns non-zero `position.x` / `position.y` when nodes have edges between them (verified at runtime in Phase 3 research). For isolated single-node graphs, positions may be zero — use 2+ workbooks with edges for position validation.
- Named range: when `showNamedRanges: true` AND `ref.namedRangeName` is set on a `SheetReference`, `buildGraph()` creates an intermediate NR node (type: 'sheet', `isNamedRange: true`) and two 'named-range' edges instead of one direct edge.

The `makeWorkbook()` factory and `zeroWorkload` constant already exist in `tests/unit/graph.test.ts` from Plan 01. Do NOT redefine them — import or use them from the existing file scope.

Grouped layout pitfall (from research GRAPH-05):
Use 2 workbooks with a cross-file reference between them so inter-group edges drive Dagre positioning. With a single isolated workbook, Dagre may assign position (0, 0) for a disconnected node.
</interfaces>

<pitfalls>
**Pitfall 4 — Overview mode external nodes:**
`buildOverviewGraph()` creates an extra file node for any cross-workbook reference whose target is not in the uploaded list. For GRAPH-06, the assertion must be `nodes.filter(n => !n.data.isExternal).length === workbooks.length`. Design the overview topology to either have no external refs, OR use this filter.

**Pitfall 6 — Named range node not created:**
NR node creation requires BOTH `showNamedRanges: true` AND `ref.namedRangeName` truthy. If `namedRangeName` is missing from the `SheetReference`, no NR node appears regardless of the flag. Verify the fixture SheetReference has `namedRangeName` set.

**Named range target sheet must differ from source sheet:**
If `namedRangeName` ref has `targetSheet` equal to source sheet, it gets filtered as a self-edge. Use `targetSheet: 'Sheet2'` when source sheet is `Sheet1`.

**Do NOT use the word "annotation" in test comments** — triggers false @vitest-environment module resolution (discovered Phase 2).

**Grouped layout position validation:**
Do NOT assert exact coordinate values — Dagre positions change with node counts. Assert `> 0` only.
</pitfalls>
</context>

<tasks>

<task type="tdd">
  <name>Task 1: Add GRAPH-05 (layout positions) and GRAPH-06 (overview mode)</name>
  <files>tests/unit/graph.test.ts</files>
  <action>
Append two describe blocks to the end of `tests/unit/graph.test.ts`.

**GRAPH-05 describe block** — all three layout modes return non-empty arrays with non-zero positions.

Use a two-workbook topology with a cross-file reference so Dagre has edges to drive non-trivial positioning:

```typescript
describe('GRAPH-05: all layout modes return non-empty nodes with valid positions', () => {
  // Two workbooks with a cross-file reference — ensures inter-group edges in grouped layout
  const crossFileRef: SheetReference = {
    targetWorkbook: 'FileB.xlsx',
    targetSheet: 'Sheet1',
    cells: ['A1'],
    formula: '[FileB.xlsx]Sheet1!A1',
    sourceCell: 'A1',
  }
  const wbA = makeWorkbook('FileA.xlsx', [{ sheetName: 'Sheet1', refs: [crossFileRef] }])
  const wbB = makeWorkbook('FileB.xlsx', [{ sheetName: 'Sheet1' }])

  it('graph layout returns non-empty nodes with non-zero positions', () => {
    const { nodes } = buildGraph([wbA, wbB], 'graph')
    expect(nodes.length).toBeGreaterThan(0)
    for (const node of nodes) {
      expect(node.position.x).toBeGreaterThan(0)
      expect(node.position.y).toBeGreaterThan(0)
    }
  })

  it('grouped layout returns non-empty nodes with non-zero positions', () => {
    const { nodes } = buildGraph([wbA, wbB], 'grouped')
    expect(nodes.length).toBeGreaterThan(0)
    for (const node of nodes) {
      expect(node.position.x).toBeGreaterThan(0)
      expect(node.position.y).toBeGreaterThan(0)
    }
  })

  it('overview layout returns non-empty nodes with non-zero positions', () => {
    const { nodes } = buildGraph([wbA, wbB], 'overview')
    expect(nodes.length).toBeGreaterThan(0)
    for (const node of nodes) {
      expect(node.position.x).toBeGreaterThan(0)
      expect(node.position.y).toBeGreaterThan(0)
    }
  })
})
```

**GRAPH-06 describe block** — overview mode returns exactly one node per uploaded workbook.

Use a clean topology with no external refs so the `nodes.filter(n => !n.data.isExternal)` filter is not needed (though include it defensively):

```typescript
describe('GRAPH-06: overview mode returns one node per uploaded workbook', () => {
  it('two uploaded workbooks produce exactly two non-external nodes in overview mode', () => {
    // Use cross-file refs so overview has edges, but both targets are uploaded
    const crossFileRef: SheetReference = {
      targetWorkbook: 'FileB.xlsx',
      targetSheet: 'Sheet1',
      cells: ['A1'],
      formula: '[FileB.xlsx]Sheet1!A1',
      sourceCell: 'A1',
    }
    const wbA = makeWorkbook('FileA.xlsx', [
      { sheetName: 'Sheet1', refs: [crossFileRef] },
      { sheetName: 'Sheet2' },
    ])
    const wbB = makeWorkbook('FileB.xlsx', [{ sheetName: 'Sheet1' }])

    const { nodes } = buildGraph([wbA, wbB], 'overview')
    // Filter out any external file nodes — only count uploaded workbook nodes
    const uploadedNodes = nodes.filter(n => !n.data.isExternal)
    expect(uploadedNodes).toHaveLength(2)
  })

  it('three uploaded workbooks produce exactly three non-external nodes in overview mode', () => {
    const wbA = makeWorkbook('FileA.xlsx', [{ sheetName: 'Sheet1' }])
    const wbB = makeWorkbook('FileB.xlsx', [{ sheetName: 'Sheet1' }])
    const wbC = makeWorkbook('FileC.xlsx', [{ sheetName: 'Sheet1' }])
    const { nodes } = buildGraph([wbA, wbB, wbC], 'overview')
    const uploadedNodes = nodes.filter(n => !n.data.isExternal)
    expect(uploadedNodes).toHaveLength(3)
  })
})
```

Run `npm test` and verify GRAPH-05 and GRAPH-06 pass before Task 2.
  </action>
  <verify>
    <automated>cd /c/Users/chase/projects/tangle && npm test -- --reporter=verbose 2>&1 | tail -50</automated>
  </verify>
  <done>
    `npm test` passes. GRAPH-05 describe block has 3 passing tests. GRAPH-06 describe block has 2 passing tests. All prior tests remain green.
  </done>
</task>

<task type="tdd">
  <name>Task 2: Add GRAPH-07 (named range node toggle), verify full suite</name>
  <files>tests/unit/graph.test.ts</files>
  <action>
Append the final describe block for GRAPH-07 to `tests/unit/graph.test.ts`, then run the full suite to confirm all 7 GRAPH requirement groups pass.

**GRAPH-07 describe block** — named range nodes toggle with `showNamedRanges` flag:

```typescript
describe('GRAPH-07: named range nodes toggle with showNamedRanges flag', () => {
  // Sheet1 has a named range ref pointing to Sheet2 — target sheet differs from source (no self-edge)
  const namedRangeRef: SheetReference = {
    targetWorkbook: null,
    targetSheet: 'Sheet2',
    cells: ['A1:A10'],
    formula: 'MyRange',
    sourceCell: 'A1',
    namedRangeName: 'MyRange',
  }
  const wbWithNR = makeWorkbook('FileA.xlsx', [
    { sheetName: 'Sheet1', refs: [namedRangeRef] },
    { sheetName: 'Sheet2' },
  ])

  it('showNamedRanges=false: no named range nodes in output', () => {
    const { nodes } = buildGraph([wbWithNR], 'graph', new Set(), false)
    expect(nodes.some(n => n.data.isNamedRange)).toBe(false)
  })

  it('showNamedRanges=true: named range node appears in output', () => {
    const { nodes } = buildGraph([wbWithNR], 'graph', new Set(), true)
    expect(nodes.some(n => n.data.isNamedRange)).toBe(true)
  })

  it('showNamedRanges=true: named range node has correct namedRangeName', () => {
    const { nodes } = buildGraph([wbWithNR], 'graph', new Set(), true)
    const nrNode = nodes.find(n => n.data.isNamedRange)
    expect(nrNode).toBeDefined()
    expect(nrNode?.data.namedRangeName).toBe('MyRange')
  })

  it('showNamedRanges=true: named-range edges replace the direct edge', () => {
    const { edges } = buildGraph([wbWithNR], 'graph', new Set(), true)
    // Direct edge replaced by two 'named-range' edges (source→NR and NR→consumer)
    expect(edges.every(e => e.data.edgeKind === 'named-range')).toBe(true)
    expect(edges).toHaveLength(2)
  })

  it('showNamedRanges=false: a direct edge exists (not named-range kind)', () => {
    const { edges } = buildGraph([wbWithNR], 'graph', new Set(), false)
    expect(edges).toHaveLength(1)
    expect(edges[0].data.edgeKind).not.toBe('named-range')
  })
})
```

After writing GRAPH-07, run the full test suite including coverage to verify everything:
```
npm run test:coverage
```

Confirm:
- All 7 GRAPH describe blocks pass
- All 22 parser tests still pass (no regressions)
- Coverage report generated in `coverage/`
  </action>
  <verify>
    <automated>cd /c/Users/chase/projects/tangle && npm test -- --reporter=verbose 2>&1 | tail -60</automated>
  </verify>
  <done>
    `npm test` passes with all GRAPH-01 through GRAPH-07 describe blocks green. All 22 parser tests remain green. `tests/unit/graph.test.ts` contains all 7 describe blocks with no TypeScript errors. Phase 3 is complete.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
- `npm test` passes the full unit test suite (parser tests + all 7 GRAPH describe blocks) with zero failures
- `tests/unit/graph.test.ts` contains exactly 7 describe blocks: GRAPH-01 through GRAPH-07
- GRAPH-05 tests pass with non-zero `position.x` and `position.y` for all three layout modes
- GRAPH-06 tests confirm `nodes.filter(n => !n.data.isExternal).length === workbooks.length` for overview mode
- GRAPH-07 tests confirm named range nodes appear/disappear correctly with the `showNamedRanges` flag
- No regressions in existing tests
</verification>

<success_criteria>
- `npm test` output: all tests pass, no failures, no skipped tests
- All 7 requirement IDs (GRAPH-01 through GRAPH-07) covered by describe blocks in `tests/unit/graph.test.ts`
- Phase 3 can be marked complete in STATE.md and ROADMAP.md
</success_criteria>

<output>
After completion, create `.planning/phases/03-graph-unit-tests/03-02-SUMMARY.md` following the summary template.
</output>
