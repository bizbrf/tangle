---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - playwright.config.ts
  - tests/e2e/smoke.spec.ts
autonomous: true
requirements:
  - INFRA-06

must_haves:
  truths:
    - "Running `npm run test:e2e` starts the Vite dev server and runs Playwright against localhost:5173 without hanging"
    - "The smoke test confirms the app loads a visible page at the root URL"
    - "playwright.config.ts uses webServer.url (not deprecated webServer.port)"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright runner configuration targeting localhost:5173"
      contains: "url: 'http://localhost:5173'"
    - path: "tests/e2e/smoke.spec.ts"
      provides: "Minimal E2E smoke test that verifies app loads"
      contains: "page.goto('/')"
  key_links:
    - from: "playwright.config.ts"
      to: "http://localhost:5173"
      via: "webServer.command = 'npm run dev' + webServer.url"
      pattern: "url.*localhost:5173"
    - from: "tests/e2e/smoke.spec.ts"
      to: "playwright.config.ts"
      via: "testDir: './tests/e2e'"
      pattern: "page.goto"
---

<objective>
Create `playwright.config.ts` with the correct `webServer.url` pattern and a minimal E2E smoke test that confirms the app loads at localhost:5173.

Purpose: Establishes the E2E test runner so Phase 4 can write feature tests without infrastructure work. The smoke test validates the full Playwright + Vite dev server integration works end-to-end.
Output: playwright.config.ts, tests/e2e/smoke.spec.ts.
</objective>

<execution_context>
@C:/Users/chase/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/chase/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md
</context>

<interfaces>
<!-- From Plan 01: package.json now has these scripts -->
<!-- "test:e2e": "playwright test" -->
<!-- "dev": "vite" (existing) -->
<!-- tsconfig.node.json now includes playwright.config.ts -->
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and create playwright.config.ts</name>
  <files>
    playwright.config.ts
  </files>
  <action>
    Install Playwright (Chromium only — sufficient for Windows/Tauri target):

    ```bash
    npm install -D @playwright/test@^1.58.2
    npx playwright install chromium
    ```

    Create `playwright.config.ts` at the project root:

    ```typescript
    import { defineConfig, devices } from '@playwright/test'

    export default defineConfig({
      testDir: './tests/e2e',
      fullyParallel: true,
      forbidOnly: !!process.env.CI,
      retries: process.env.CI ? 2 : 0,
      reporter: 'html',
      use: {
        baseURL: 'http://localhost:5173',
        trace: 'on-first-retry',
      },
      projects: [
        {
          name: 'chromium',
          use: { ...devices['Desktop Chrome'] },
        },
      ],
      webServer: {
        command: 'npm run dev',
        url: 'http://localhost:5173',
        reuseExistingServer: !process.env.CI,
        timeout: 30000,
      },
    })
    ```

    Critical decisions (from RESEARCH.md):
    - Use `webServer.url` NOT `webServer.port` — `port` is deprecated as of Playwright 1.57+; `url` verifies the server actually responds (not just that the port is open)
    - `reuseExistingServer: !process.env.CI` — locally, reuse a running dev server to avoid slow cold starts; in CI, always start fresh
    - `fullyParallel: true` — fine for Phase 1 (single test file); Phase 4 tests will be independent enough to benefit
    - `timeout: 30000` — Vite cold-start with Tauri setup can be slow; 30s is safe
    - `testDir: './tests/e2e'` — keeps E2E tests separate from unit tests in `tests/unit/`

    The `playwright.config.ts` file is already included in `tsconfig.node.json` from Plan 01 (Task 2 added it to the include array), so TypeScript will type-check it correctly.
  </action>
  <verify>
    ```bash
    cd C:/Users/chase/projects/tangle && node --input-type=module --eval "import('./playwright.config.ts')" 2>&1 | head -5 || true
    ```
    Check @playwright/test is installed:
    ```bash
    cd C:/Users/chase/projects/tangle && ls node_modules/@playwright/test/package.json 2>/dev/null && echo "playwright installed" || echo "playwright missing"
    ```
  </verify>
  <done>@playwright/test is in package.json devDependencies; playwright.config.ts exists with webServer.url (not port); Chromium browser is downloaded</done>
</task>

<task type="auto">
  <name>Task 2: Create E2E smoke test and tests directory structure</name>
  <files>
    tests/e2e/smoke.spec.ts
    tests/helpers/upload.ts
  </files>
  <action>
    Create the `tests/e2e/` directory and smoke test:

    ```typescript
    // tests/e2e/smoke.spec.ts
    import { test, expect } from '@playwright/test'

    test('app loads at localhost:5173', async ({ page }) => {
      await page.goto('/')
      await expect(page.locator('body')).toBeVisible()
    })

    test('app renders the graph canvas', async ({ page }) => {
      await page.goto('/')
      // The React Flow container should be present in the DOM
      // even before any file is uploaded (empty state)
      await expect(page.locator('.react-flow')).toBeVisible()
    })
    ```

    The second test confirms React Flow renders its container — a stronger check than just `body`. This catches broken builds where the page loads but React fails to mount.

    Also create the helpers stub (Phase 4 will implement `uploadFile()` fully):

    ```typescript
    // tests/helpers/upload.ts
    // File upload helper for E2E tests — implemented in Phase 4
    // Stub created here to establish the directory structure

    import type { Page } from '@playwright/test'

    /**
     * Uploads a fixture file via the hidden <input type="file"> element.
     * Phase 4 will implement this fully once E2E upload tests are written.
     */
    export async function uploadFile(page: Page, fixturePath: string): Promise<void> {
      const input = page.locator('input[type="file"]')
      await input.setInputFiles(fixturePath)
    }
    ```

    The `upload.ts` stub is intentionally minimal — it establishes the pattern (using `setInputFiles()` per RESEARCH.md recommendation) without implementing the full helper.
  </action>
  <verify>
    Run the E2E smoke test:
    ```bash
    cd C:/Users/chase/projects/tangle && npm run test:e2e 2>&1 | tail -20
    ```
    Both smoke tests should pass. If the dev server fails to start, check that `npm run dev` starts Vite on port 5173 (strictPort: true in vite.config.ts guarantees this).
  </verify>
  <done>`npm run test:e2e` exits 0; both smoke tests pass (app loads + React Flow container visible); tests/e2e/smoke.spec.ts and tests/helpers/upload.ts exist</done>
</task>

</tasks>

<verification>
```bash
cd C:/Users/chase/projects/tangle && npm run test:e2e 2>&1 | tail -10
```
Must show "2 passed" with no failures.

```bash
cd C:/Users/chase/projects/tangle && grep "url.*5173" playwright.config.ts
```
Must print the `url: 'http://localhost:5173'` line (confirming no deprecated `port` usage).
</verification>

<success_criteria>
- `npm run test:e2e` exits 0 with 2 passing tests
- playwright.config.ts uses `webServer.url` (not `webServer.port`)
- Chromium browser is installed (npx playwright install chromium completed)
- tests/e2e/smoke.spec.ts exists with app-load and React Flow visibility checks
- tests/helpers/upload.ts exists as a typed stub
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md` following the summary template.
</output>
