---
phase: 04-e2e-tests
plan: 03
type: execute
wave: 3
depends_on:
  - 04-02
files_modified:
  - tests/e2e/interactions.spec.ts
  - tests/e2e/detail-panel.spec.ts
  - tests/e2e/errors.spec.ts
autonomous: true
requirements:
  - E2E-05
  - E2E-06
  - E2E-07
  - E2E-08
  - E2E-09
  - E2E-10
  - E2E-11
  - E2E-12
  - E2E-13
  - E2E-14
  - E2E-15

must_haves:
  truths:
    - "Switching layout mode to Overview changes the node count to fewer than Graph mode"
    - "Toggling an edge filter button removes edges of that kind from the graph DOM"
    - "Clicking eye icon on a file (after hover) hides that file's nodes from the graph"
    - "Clicking eye icon again restores the hidden nodes"
    - "Clicking a node and clicking Focus activates focus mode panel"
    - "Clicking a sheet node opens the detail panel with the sheet name"
    - "Detail panel shows workload metrics grid with formula counts"
    - "Clicking an edge opens the detail panel in References mode"
    - "Uploading a .txt file shows the upload-error message"
    - "Uploading a corrupt .xlsx file shows the upload-error message"
    - "After a failed upload, previously uploaded files remain visible in the graph"
  artifacts:
    - path: "tests/e2e/interactions.spec.ts"
      provides: "E2E-05 through E2E-09 feature interaction tests"
      contains: "E2E-05"
    - path: "tests/e2e/detail-panel.spec.ts"
      provides: "E2E-10 through E2E-12 detail panel tests"
      contains: "E2E-10"
    - path: "tests/e2e/errors.spec.ts"
      provides: "E2E-13 through E2E-15 error handling tests"
      contains: "E2E-13"
  key_links:
    - from: "interactions.spec.ts E2E-07"
      to: "data-testid=\"eye-toggle\""
      via: "fileRow.hover() then fileRow.getByTestId('eye-toggle').click()"
      pattern: "hover"
    - from: "detail-panel.spec.ts E2E-10"
      to: "data-testid=\"detail-panel\""
      via: "waitForDetailPanel() after node click"
      pattern: "waitForDetailPanel"
    - from: "errors.spec.ts E2E-13"
      to: "data-testid=\"upload-error\""
      via: "page.getByTestId('upload-error').waitFor({ state: 'visible' })"
      pattern: "waitFor"
---

<objective>
Create the three remaining E2E spec files covering feature interactions, the detail panel, and error handling.

Purpose: These 11 tests complete the full E2E coverage required by E2E-05 through E2E-15, validating that every major user interaction works correctly in a real browser.
Output: tests/e2e/interactions.spec.ts (5 tests), tests/e2e/detail-panel.spec.ts (3 tests), tests/e2e/errors.spec.ts (3 tests) — all passing.
</objective>

<execution_context>
@C:/Users/chase/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/chase/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-e2e-tests/04-02-SUMMARY.md
@tests/e2e/helpers.ts

<interfaces>
<!-- Key patterns from research and prior plans -->

From tests/e2e/helpers.ts (created in plan 04-02):
```typescript
export function fixturePath(filename: string): string  // resolves absolute path to fixture
export async function uploadFile(page: Page, filename: string): Promise<void>
export async function uploadFiles(page: Page, filenames: string[]): Promise<void>
export async function waitForNodes(page: Page): Promise<void>
export async function waitForDetailPanel(page: Page): Promise<void>
```

Key data-testid values (added in plan 04-01):
- FilePanel: "file-list-item", "sheet-list-item", "eye-toggle", "upload-error"
- GraphView SheetNode: "sheet-node" (all 3 branches — named-range, file-node, regular)
- GraphView DetailPanel: "detail-panel", "detail-panel-title", "workload-metrics"
- GraphView Toolbar: "layout-graph", "layout-grouped", "layout-overview"
- GraphView EdgeKindFilterBar: "edge-filter-internal", "edge-filter-cross-file", "edge-filter-external", "edge-filter-named-range"
- GraphView Focus panel: "focus-panel"

Critical pitfalls:
- Eye button is opacity-0 until hover: MUST call fileRow.hover() before fileRow.getByTestId('eye-toggle').click()
- React Flow node clicks may be intercepted by canvas pane: use click({ force: true }) as fallback
- DetailPanel returns null until selection: use waitForDetailPanel() after node click
- upload-error is conditionally rendered: use waitFor({ state: 'visible' }) not immediate assertion
- Overview mode: assert overviewCount < graphCount (not exact count) — exact count depends on fixture sheets
- Edge click for E2E-12: target the edge label badge div (pointerEvents: 'all') not the SVG path directly; use external-ref.xlsx which should have edges with refCount > 1 (label badge visible)
- Focus mode: activated via "Focus" button in DetailPanel (not double-click); must click node first, wait for panel, then click Focus button
- Never use page.waitForTimeout() — all waits must be element-based using Playwright's auto-wait or waitFor()
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests/e2e/interactions.spec.ts (E2E-05 through E2E-09)</name>
  <files>tests/e2e/interactions.spec.ts</files>
  <action>
Create the interactions spec with 5 tests. All use external-ref.xlsx (has both internal and external edges, multiple sheets per workbook) unless noted.

```typescript
import { test, expect } from '@playwright/test'
import { uploadFile, waitForNodes, waitForDetailPanel } from './helpers'

test.beforeEach(async ({ page }) => {
  await page.goto('/')
})

// E2E-05: Switching layout mode updates graph node count
test('E2E-05: switching to Overview mode reduces node count', async ({ page }) => {
  await uploadFile(page, 'external-ref.xlsx')
  await waitForNodes(page)

  // Count in Graph mode (default) — should be >1 for a multi-sheet workbook
  const graphCount = await page.getByTestId('sheet-node').count()
  expect(graphCount).toBeGreaterThan(0)

  // Switch to Overview mode — one node per workbook
  await page.getByTestId('layout-overview').click()

  // Overview should have fewer nodes (1 per workbook, not 1 per sheet)
  await expect(page.getByTestId('sheet-node')).toHaveCount(1)
})

// E2E-06: Toggling edge kind filter removes those edges from graph
test('E2E-06: toggling edge filter removes edges from graph', async ({ page }) => {
  await uploadFile(page, 'external-ref.xlsx')
  await waitForNodes(page)

  // Capture edge count before toggle (external edges visible by default)
  const edgesBefore = await page.locator('.react-flow__edge').count()
  expect(edgesBefore).toBeGreaterThan(0)

  // Toggle external edges off
  await page.getByTestId('edge-filter-external').click()

  // After toggle, edge count should decrease (React Flow removes edge elements from DOM)
  // Use toHaveCount with a value less than edgesBefore — Playwright retries until satisfied
  await expect(page.locator('.react-flow__edge')).not.toHaveCount(edgesBefore)

  // Toggle back on — edges should be restored
  await page.getByTestId('edge-filter-external').click()

  // Edge count should return to the original count
  await expect(page.locator('.react-flow__edge')).toHaveCount(edgesBefore)
})

// E2E-07: Eye icon hides file's nodes from graph
test('E2E-07: clicking eye icon hides file nodes from graph', async ({ page }) => {
  await uploadFile(page, 'external-ref.xlsx')
  await waitForNodes(page)

  const nodesBefore = await page.getByTestId('sheet-node').count()
  expect(nodesBefore).toBeGreaterThan(0)

  // Eye button is opacity-0 group-hover:opacity-100 — hover the file row first
  const fileRow = page.getByTestId('file-list-item').first()
  await fileRow.hover()
  await fileRow.getByTestId('eye-toggle').click()

  // After hiding, nodes from that file should be gone
  // external-ref.xlsx is the only uploaded file, so 0 nodes expected
  await expect(page.getByTestId('sheet-node')).toHaveCount(0)
})

// E2E-08: Eye icon re-show restores hidden nodes
test('E2E-08: clicking eye icon again restores hidden nodes', async ({ page }) => {
  await uploadFile(page, 'external-ref.xlsx')
  await waitForNodes(page)

  const nodesBefore = await page.getByTestId('sheet-node').count()

  // Hide
  const fileRow = page.getByTestId('file-list-item').first()
  await fileRow.hover()
  await fileRow.getByTestId('eye-toggle').click()
  await expect(page.getByTestId('sheet-node')).toHaveCount(0)

  // Re-show (hover again before clicking toggle)
  await fileRow.hover()
  await fileRow.getByTestId('eye-toggle').click()

  // Nodes should return to original count
  await expect(page.getByTestId('sheet-node')).toHaveCount(nodesBefore)
})

// E2E-09: Focus mode activates when clicking Focus button in detail panel
test('E2E-09: clicking Focus activates focus mode panel', async ({ page }) => {
  await uploadFile(page, 'external-ref.xlsx')
  await waitForNodes(page)

  // Click first sheet node (may need force: true for RF canvas overlay)
  const firstNode = page.getByTestId('sheet-node').first()
  await firstNode.click({ force: true })

  // Wait for detail panel to appear
  await waitForDetailPanel(page)

  // Click Focus button in detail panel
  // The button text is 'Focus' (or 'Focused' if already focused)
  await page.getByRole('button', { name: 'Focus' }).click()

  // Focus panel should appear (data-testid="focus-panel")
  await expect(page.getByTestId('focus-panel')).toBeVisible()
})
```

Note for E2E-06: The `.react-flow__edge` count assertion replaces any fixed timeout. Playwright retries `toHaveCount` and `not.toHaveCount` automatically until the assertion passes or the test times out — no `waitForTimeout` needed or allowed.

Note for E2E-05: external-ref.xlsx fixture has multiple sheets, so graphCount > 1 and overviewCount === 1. Use `toHaveCount(1)` rather than `< graphCount` for a more precise assertion.
  </action>
  <verify>
    <automated>cd C:/Users/chase/projects/tangle && npm run test:e2e -- interactions.spec.ts 2>&1 | tail -30</automated>
  </verify>
  <done>All 5 interaction tests pass: E2E-05 (layout switch), E2E-06 (edge count decreases after filter toggle and returns after toggle-back — verified via .react-flow__edge count assertions, no waitForTimeout used), E2E-07 (hide nodes), E2E-08 (restore nodes), E2E-09 (focus panel appears)</done>
</task>

<task type="auto">
  <name>Task 2: Create tests/e2e/detail-panel.spec.ts (E2E-10 through E2E-12)</name>
  <files>tests/e2e/detail-panel.spec.ts</files>
  <action>
Create the detail panel spec with 3 tests. Use cross-sheet.xlsx for E2E-10 and E2E-11 (workload metrics guaranteed). For E2E-12, use cross-sheet.xlsx first — if it has no edge labels, fall back to external-ref.xlsx.

```typescript
import { test, expect } from '@playwright/test'
import { uploadFile, waitForNodes, waitForDetailPanel } from './helpers'

test.beforeEach(async ({ page }) => {
  await page.goto('/')
})

// E2E-10: Clicking a sheet node opens the detail panel with sheet name
test('E2E-10: clicking sheet node opens detail panel', async ({ page }) => {
  await uploadFile(page, 'cross-sheet.xlsx')
  await waitForNodes(page)

  // Click the first sheet node (force: true bypasses RF canvas overlay)
  await page.getByTestId('sheet-node').first().click({ force: true })

  // Detail panel should appear
  await waitForDetailPanel(page)
  await expect(page.getByTestId('detail-panel')).toBeVisible()

  // Panel title should show 'Sheet' (not 'References' or a multi-select count)
  await expect(page.getByTestId('detail-panel-title')).toContainText('Sheet')
})

// E2E-11: Detail panel shows workload metrics
test('E2E-11: detail panel shows workload metrics', async ({ page }) => {
  await uploadFile(page, 'cross-sheet.xlsx')
  await waitForNodes(page)

  await page.getByTestId('sheet-node').first().click({ force: true })
  await waitForDetailPanel(page)

  // Workload metrics grid should be visible (only shows for nodes with workload data)
  // cross-sheet.xlsx has formulas, so workload is non-null
  await expect(page.getByTestId('workload-metrics')).toBeVisible()

  // At least one metric label should be visible ('formulas' is always shown)
  await expect(page.getByTestId('workload-metrics')).toContainText('formulas')
})

// E2E-12: Clicking an edge opens the detail panel in References mode
test('E2E-12: clicking an edge opens detail panel with References header', async ({ page }) => {
  await uploadFile(page, 'cross-sheet.xlsx')
  await waitForNodes(page)

  // React Flow edges: try clicking the edge label badge (pointerEvents: 'all')
  // The edge label badge appears for edges with refCount > 1 as a positioned div
  // For single-ref edges, fall back to clicking the SVG path via .react-flow__edge
  const edgeLabel = page.locator('.react-flow__edge-label').first()
  const edgePath = page.locator('.react-flow__edge').first()

  // Check if edge labels exist (multi-ref edges); otherwise click the SVG edge
  const labelCount = await edgeLabel.count()
  if (labelCount > 0) {
    await edgeLabel.first().click({ force: true })
  } else {
    await edgePath.first().click({ force: true })
  }

  // Detail panel should show References mode
  await waitForDetailPanel(page)
  await expect(page.getByTestId('detail-panel-title')).toContainText('References')
})
```

Note on E2E-12 edge click: The approach tries edge labels first (for multi-ref edges), then falls back to clicking the RF edge element. If cross-sheet.xlsx has only single-ref edges with no label badge and SVG path click fails, switch the fixture to external-ref.xlsx and update the test accordingly. The detail panel title for edge selection shows 'References'.
  </action>
  <verify>
    <automated>cd C:/Users/chase/projects/tangle && npm run test:e2e -- detail-panel.spec.ts 2>&1 | tail -20</automated>
  </verify>
  <done>All 3 detail panel tests pass: E2E-10 (detail panel opens with Sheet title), E2E-11 (workload metrics visible and contains 'formulas'), E2E-12 (edge click shows References title in detail panel)</done>
</task>

<task type="auto">
  <name>Task 3: Create tests/e2e/errors.spec.ts (E2E-13 through E2E-15)</name>
  <files>tests/e2e/errors.spec.ts</files>
  <action>
Create the error handling spec with 3 tests. Use not-excel.txt for E2E-13 and malformed.xlsx for E2E-14 and E2E-15.

```typescript
import { test, expect } from '@playwright/test'
import { uploadFile, waitForNodes } from './helpers'

test.beforeEach(async ({ page }) => {
  await page.goto('/')
})

// E2E-13: Uploading a .txt file shows error message
test('E2E-13: uploading a .txt file shows error message without crash', async ({ page }) => {
  await uploadFile(page, 'not-excel.txt')

  // Error is conditionally rendered — wait for it to appear
  const error = page.getByTestId('upload-error')
  await error.waitFor({ state: 'visible' })

  // Error message should mention Excel files
  await expect(error).toContainText('Excel')

  // App did not crash — file input is still in the DOM
  await expect(page.locator('input[type="file"]')).toBeAttached()
})

// E2E-14: Uploading a corrupt .xlsx file shows error message
test('E2E-14: uploading corrupt .xlsx shows error message', async ({ page }) => {
  await uploadFile(page, 'malformed.xlsx')

  // Error message should appear
  const error = page.getByTestId('upload-error')
  await error.waitFor({ state: 'visible' })
  await expect(error).toBeVisible()
})

// E2E-15: App remains usable after a failed upload
test('E2E-15: app remains usable after failed upload', async ({ page }) => {
  // Upload a valid file first
  await uploadFile(page, 'cross-sheet.xlsx')
  await waitForNodes(page)

  // Verify good file is visible
  await expect(
    page.getByTestId('file-list-item').filter({ hasText: 'cross-sheet.xlsx' })
  ).toBeVisible()

  // Now upload a corrupt file — this should show an error but NOT remove the good file
  await uploadFile(page, 'malformed.xlsx')

  // Wait for error to appear
  await page.getByTestId('upload-error').waitFor({ state: 'visible' })

  // Good file's nodes should still be visible in the graph
  await expect(page.getByTestId('sheet-node').first()).toBeVisible()

  // Good file should still be in the sidebar
  await expect(
    page.getByTestId('file-list-item').filter({ hasText: 'cross-sheet.xlsx' })
  ).toBeVisible()
})
```
  </action>
  <verify>
    <automated>cd C:/Users/chase/projects/tangle && npm run test:e2e -- errors.spec.ts 2>&1 | tail -20</automated>
  </verify>
  <done>All 3 error tests pass: E2E-13 (txt upload shows 'Excel' error message, app not crashed), E2E-14 (corrupt xlsx shows error), E2E-15 (good file's nodes and sidebar entry survive a subsequent failed upload)</done>
</task>

</tasks>

<verification>
Run the full E2E suite to confirm all 15 tests pass:
cd C:/Users/chase/projects/tangle && npm run test:e2e 2>&1 | tail -30

Expected output: 15 passed (plus 1 existing smoke test = 16 total)
</verification>

<success_criteria>
- tests/e2e/interactions.spec.ts has 5 tests (E2E-05 through E2E-09) all passing
- tests/e2e/detail-panel.spec.ts has 3 tests (E2E-10 through E2E-12) all passing
- tests/e2e/errors.spec.ts has 3 tests (E2E-13 through E2E-15) all passing
- npm run test:e2e exits 0 (all 16 tests pass including existing smoke test)
- No fixed timeouts (waitForTimeout) used in any spec — all waits are element-based or waitFor()
- E2E-06 verifies edge removal via .react-flow__edge count assertions (before/after toggle)
- All 15 E2E requirements (E2E-01 through E2E-15) are covered by passing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-e2e-tests/04-03-SUMMARY.md`
</output>
