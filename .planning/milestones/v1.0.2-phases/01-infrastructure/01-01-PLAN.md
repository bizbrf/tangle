---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.ts
  - tsconfig.node.json
  - tsconfig.test.json
  - eslint.config.js
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-05
  - INFRA-06
  - INFRA-07

must_haves:
  truths:
    - "Running `npm test` executes Vitest without module resolution errors"
    - "Running `npm run test:coverage` generates an HTML coverage report in coverage/"
    - "Running `npm run build` still succeeds after config changes"
    - "vitest.config.ts is a separate file from vite.config.ts"
    - "All five npm scripts are registered: test, test:e2e, test:coverage, test:watch, fixtures:generate"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest runner configuration with SheetJS inline fix and coverage settings"
      contains: "server.deps.inline: ['xlsx']"
    - path: "tsconfig.node.json"
      provides: "Updated tsconfig including vitest.config.ts"
      contains: "vitest.config.ts"
    - path: "tsconfig.test.json"
      provides: "Test-file TypeScript context (extends tsconfig.node.json, includes tests/**)"
      contains: "tests/**/*.ts"
    - path: "package.json"
      provides: "npm scripts for test, test:e2e, test:coverage, test:watch, fixtures:generate"
      contains: "vitest run"
  key_links:
    - from: "vitest.config.ts"
      to: "xlsx"
      via: "test.server.deps.inline"
      pattern: "inline.*xlsx"
    - from: "tsconfig.node.json"
      to: "vitest.config.ts"
      via: "include array"
      pattern: "vitest.config.ts"
    - from: "eslint.config.js"
      to: "tsconfig.test.json"
      via: "languageOptions.parserOptions"
      pattern: "tsconfig.test.json"
---

<objective>
Install and configure the Vitest unit test runner with coverage reporting, register all npm test scripts, and update TypeScript + ESLint configs so the toolchain understands test files.

Purpose: Before any test can be written, the test runner must resolve SheetJS correctly, TypeScript must type-check test files cleanly, and ESLint must not reject test file imports.
Output: vitest.config.ts, tsconfig.test.json, updated tsconfig.node.json, updated eslint.config.js, five npm scripts in package.json.
</objective>

<execution_context>
@C:/Users/chase/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/chase/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and create vitest.config.ts</name>
  <files>
    package.json
    vitest.config.ts
  </files>
  <action>
    Install Vitest dependencies:

    ```bash
    npm install -D vitest@^4.0.18 @vitest/coverage-v8@^4.0.18 jsdom@^28.1.0
    ```

    Create `vitest.config.ts` in the project root with this exact content — do NOT merge into `vite.config.ts`:

    ```typescript
    /// <reference types="vitest/config" />
    import { defineConfig } from 'vitest/config'
    import react from '@vitejs/plugin-react'

    export default defineConfig({
      plugins: [react()],
      test: {
        environment: 'node',
        globals: true,
        include: ['tests/unit/**/*.test.ts'],
        server: {
          deps: {
            inline: ['xlsx'],
          },
        },
        coverage: {
          provider: 'v8',
          reporter: ['text', 'html'],
          reportsDirectory: './coverage',
          include: ['src/lib/**/*.ts'],
          exclude: ['src/**/*.d.ts'],
        },
      },
    })
    ```

    Key decisions documented in research:
    - `environment: 'node'` (not jsdom) — parser.ts and graph.ts need no DOM; jsdom adds overhead
    - `globals: true` — enables describe/it/expect without explicit import in every test file
    - `server.deps.inline: ['xlsx']` — CRITICAL: xlsx@0.18.5 is CJS; without this line Vitest throws `ERR_REQUIRE_ESM` or `Cannot find module 'xlsx'` even though `npm run dev` works fine
    - `@vitest/coverage-v8` must match vitest version exactly — both pinned to ^4.0.18

    Then add all five npm scripts to `package.json` (do not remove existing scripts):

    ```json
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "test:e2e": "playwright test",
    "fixtures:generate": "node tests/fixtures/generate.ts"
    ```

    Note: `test:e2e` and `fixtures:generate` are registered now even though Playwright and the fixture generator are created in later plans. Registering them here avoids a second `package.json` edit.
  </action>
  <verify>
    ```bash
    cd C:/Users/chase/projects/tangle && node -e "require('./node_modules/vitest/dist/node.js')" 2>/dev/null && echo "vitest installed" || echo "vitest missing"
    ```
    Also verify no import errors by checking vitest.config.ts syntax:
    ```bash
    cd C:/Users/chase/projects/tangle && node --input-type=module --eval "import './vitest.config.ts'" 2>&1 | head -5 || true
    ```
  </verify>
  <done>vitest, @vitest/coverage-v8, and jsdom are in package.json devDependencies; vitest.config.ts exists at project root with server.deps.inline: ['xlsx']; all five npm scripts are in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript configs and ESLint for test files</name>
  <files>
    tsconfig.node.json
    tsconfig.test.json
    eslint.config.js
  </files>
  <action>
    Update `tsconfig.node.json` to include `vitest.config.ts` and `playwright.config.ts`:

    ```json
    {
      "compilerOptions": {
        "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
        "target": "ES2023",
        "lib": ["ES2023"],
        "module": "ESNext",
        "types": ["node"],
        "skipLibCheck": true,
        "moduleResolution": "bundler",
        "allowImportingTsExtensions": true,
        "verbatimModuleSyntax": true,
        "moduleDetection": "force",
        "noEmit": true,
        "strict": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "erasableSyntaxOnly": true,
        "noFallthroughCasesInSwitch": true,
        "noUncheckedSideEffectImports": true
      },
      "include": ["vite.config.ts", "vitest.config.ts", "playwright.config.ts"]
    }
    ```

    Create `tsconfig.test.json` at project root. This gives test files their own TypeScript context (separate from the app's DOM context and the node config's non-DOM context):

    ```json
    {
      "extends": "./tsconfig.node.json",
      "compilerOptions": {
        "types": ["node", "vitest/globals"],
        "noUnusedLocals": false,
        "noUnusedParameters": false
      },
      "include": ["tests/**/*.ts", "vitest.config.ts", "playwright.config.ts"]
    }
    ```

    Explanation of `tsconfig.test.json` choices:
    - `extends tsconfig.node.json` — inherits the same bundler/ESM settings; test files run in Node context
    - `types: ["node", "vitest/globals"]` — adds Vitest global types (describe, it, expect) so TypeScript recognizes them without explicit import
    - `noUnusedLocals/Parameters: false` — test files commonly declare variables for readability that aren't "used" in the strict sense
    - Does NOT include `src/` — test files import from src/ but src/ is covered by tsconfig.app.json

    Update `eslint.config.js` to add a test-file override that uses `tsconfig.test.json` for type-aware linting. Add after the existing config block:

    ```javascript
    import js from '@eslint/js'
    import globals from 'globals'
    import reactHooks from 'eslint-plugin-react-hooks'
    import reactRefresh from 'eslint-plugin-react-refresh'
    import tseslint from 'typescript-eslint'
    import { defineConfig, globalIgnores } from 'eslint/config'

    export default defineConfig([
      globalIgnores(['dist']),
      {
        files: ['**/*.{ts,tsx}'],
        extends: [
          js.configs.recommended,
          tseslint.configs.recommended,
          reactHooks.configs.flat.recommended,
          reactRefresh.configs.vite,
        ],
        languageOptions: {
          ecmaVersion: 2020,
          globals: globals.browser,
        },
      },
      {
        files: ['tests/**/*.ts'],
        extends: [
          js.configs.recommended,
          tseslint.configs.recommended,
        ],
        languageOptions: {
          ecmaVersion: 2020,
          globals: {
            ...globals.node,
          },
          parserOptions: {
            project: './tsconfig.test.json',
          },
        },
        rules: {
          '@typescript-eslint/no-unused-vars': 'warn',
        },
      },
    ])
    ```

    Note: The test file override uses `globals.node` (not `globals.browser`) and references `tsconfig.test.json` to avoid the false type-error pitfall documented in RESEARCH.md (Pitfall 5).
  </action>
  <verify>
    ```bash
    cd C:/Users/chase/projects/tangle && npx tsc -b --noEmit 2>&1 | head -20
    ```
    Build should succeed (zero TypeScript errors). Also verify lint passes:
    ```bash
    cd C:/Users/chase/projects/tangle && npm run lint 2>&1 | tail -10
    ```
  </verify>
  <done>`npm run build` succeeds (tsc -b exits 0); `npm run lint` exits 0; tsconfig.test.json exists and includes tests/**/*.ts; tsconfig.node.json includes vitest.config.ts and playwright.config.ts</done>
</task>

</tasks>

<verification>
```bash
cd C:/Users/chase/projects/tangle && npm run build 2>&1 | tail -5
```
Build must succeed. If tsc errors appear mentioning vitest.config.ts or tsconfig.test.json, the include arrays are misconfigured.

```bash
cd C:/Users/chase/projects/tangle && cat package.json | grep -E '"test|fixtures'
```
Must show all five scripts: test, test:watch, test:coverage, test:e2e, fixtures:generate.

```bash
cd C:/Users/chase/projects/tangle && grep "inline" vitest.config.ts
```
Must print the `inline: ['xlsx']` line.
</verification>

<success_criteria>
- `npm run build` exits 0 (TypeScript clean)
- `npm run lint` exits 0 (ESLint clean)
- vitest.config.ts exists with `server.deps.inline: ['xlsx']` and `environment: 'node'`
- tsconfig.node.json includes `vitest.config.ts` and `playwright.config.ts`
- tsconfig.test.json exists, extends tsconfig.node.json, includes `tests/**/*.ts`
- package.json has all five scripts: test, test:watch, test:coverage, test:e2e, fixtures:generate
- vitest, @vitest/coverage-v8, jsdom are in devDependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md` following the summary template.
</output>
